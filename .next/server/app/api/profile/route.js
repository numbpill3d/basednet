"use strict";(()=>{var e={};e.id=442,e.ids=[442],e.modules={58097:e=>{e.exports=require("@sentry/nextjs")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},15206:e=>{e.exports=require("zlib")},2094:(e,r,t)=>{t.r(r),t.d(r,{DELETE:()=>f,GET:()=>T,HEAD:()=>S,OPTIONS:()=>R,PATCH:()=>m,POST:()=>y,PUT:()=>h,authOptions:()=>d}),t(80001);var s=t(16915),a=t(61907),n=t(58097),i=t(54580),o=t(8317),u=t(35900);if(!process.env.DATABASE_URL)throw Error("DATABASE_URL is not defined");let c=new u.Pool({connectionString:process.env.DATABASE_URL,max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});async function l(e){let r=await c.connect();try{await r.query("BEGIN");let t=await e(r);return await r.query("COMMIT"),t}catch(e){throw await r.query("ROLLBACK"),e}finally{r.release()}}c.query("SELECT NOW()",e=>{e?console.error("Database connection error:",e.message):console.log("Database connected successfully")}),process.on("SIGTERM",async()=>{console.log("Closing database pool"),await c.end()});let d={providers:[{id:"indieauth",name:"IndieAuth",type:"oauth",authorization:{url:"https://indieauth.com/auth",params:{scope:"profile email"}},token:{url:"https://tokens.indieauth.com/token"},userinfo:{url:"https://indieauth.com/userinfo",request:async({tokens:e,client:r})=>({id:e.me,name:e.name||e.me,email:e.email,image:e.photo})},profile:e=>({id:e.id,name:e.name,email:e.email,image:e.image}),clientId:process.env.INDIE_AUTH_CLIENT_ID,clientSecret:process.env.INDIE_AUTH_CLIENT_SECRET}],callbacks:{async signIn({user:e,account:r,profile:t}){try{return await l(async e=>{let r=await e.query("SELECT * FROM users WHERE auth_domain = $1",[t.id]);0===r.rows.length&&(await e.query("INSERT INTO users (username, auth_domain, email) VALUES ($1, $2, $3)",[t.name,t.id,t.email]),await e.query("INSERT INTO profiles (user_id) VALUES (currval('users_id_seq'))"))}),!0}catch(e){return console.error("Error during sign in:",e),!1}},async session({session:e,user:r}){try{return await l(async r=>{let t=await r.query("SELECT * FROM users WHERE email = $1",[e.user?.email]);return t.rows[0]?{...e,user:{...e.user,id:t.rows[0].id,username:t.rows[0].username}}:e})}catch(r){return console.error("Error getting session:",r),e}}},pages:{signIn:"/auth/signin",error:"/auth/error"},debug:!1},p=(0,o.ZP)(d);function E(e,r){return"phase-production-build"===process.env.NEXT_PHASE||"function"!=typeof e?e:new Proxy(e,{apply:(e,t,o)=>{let u,c,l;try{let e=i.requestAsyncStorage.getStore();u=(0,s.h)((0,a.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("sentry-trace")]),()=>void 0),c=(0,s.h)((0,a.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("baggage")]),()=>void 0),l=(0,a.x)([e,"optionalAccess",e=>e.headers])}catch(e){}return n.wrapRouteHandlerWithSentry(e,{method:r,parameterizedRoute:"/api/auth/[...nextauth]",sentryTraceHeader:u,baggageHeader:c,headers:l}).apply(t,o)}})}let T=E(p,"GET"),y=E(p,"POST"),h=E(void 0,"PUT"),m=E(void 0,"PATCH"),f=E(void 0,"DELETE"),S=E(void 0,"HEAD"),R=E(void 0,"OPTIONS")},82699:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>q,originalPathname:()=>I,patchFetch:()=>x,requestAsyncStorage:()=>v,routeModule:()=>g,serverHooks:()=>A,staticGenerationAsyncStorage:()=>O,staticGenerationBailout:()=>P});var s={};t.r(s),t.d(s,{DELETE:()=>R,GET:()=>h,HEAD:()=>w,OPTIONS:()=>_,PATCH:()=>S,POST:()=>m,PUT:()=>f});var a=t(13223),n=t(6566),i=t(77419);t(80001);var o=t(16915),u=t(61907),c=t(58097),l=t(54580),d=t(14098),p=t(8593),E=t(95439);async function T(e){try{let r=await (0,p.ts)();if(!r)return d.Z.json({error:"Unauthorized"},{status:401});let t=await e.json(),s=await E.t.update(r.id,t);if(!s)return d.Z.json({error:"Profile not found"},{status:404});return d.Z.json({profile:s})}catch(e){return console.error("Error updating profile:",e),d.Z.json({error:"Failed to update profile"},{status:500})}}function y(e,r){return"phase-production-build"===process.env.NEXT_PHASE||"function"!=typeof e?e:new Proxy(e,{apply:(e,t,s)=>{let a,n,i;try{let e=l.requestAsyncStorage.getStore();a=(0,o.h)((0,u.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("sentry-trace")]),()=>void 0),n=(0,o.h)((0,u.x)([e,"optionalAccess",e=>e.headers,"access",e=>e.get,"call",e=>e("baggage")]),()=>void 0),i=(0,u.x)([e,"optionalAccess",e=>e.headers])}catch(e){}return c.wrapRouteHandlerWithSentry(e,{method:r,parameterizedRoute:"/api/profile",sentryTraceHeader:a,baggageHeader:n,headers:i}).apply(t,s)}})}let h=y(async function(e){try{let e=await (0,p.ts)();if(!e)return d.Z.json({error:"Unauthorized"},{status:401});let r=await E.t.findByUserId(e.id);return d.Z.json({profile:r})}catch(e){return console.error("Error fetching profile:",e),d.Z.json({error:"Failed to fetch profile"},{status:500})}},"GET"),m=y(void 0,"POST"),f=y(T,"PUT"),S=y(void 0,"PATCH"),R=y(void 0,"DELETE"),w=y(void 0,"HEAD"),_=y(void 0,"OPTIONS"),g=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/profile/route",pathname:"/api/profile",filename:"route",bundlePath:"app/api/profile/route"},resolvedPagePath:"C:\\Users\\adoni\\Desktop\\projects\\basednet\\src\\app\\api\\profile\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:O,serverHooks:A,headerHooks:q,staticGenerationBailout:P}=g,I="/api/profile/route";function x(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:O})}},80001:(e,r,t)=>{var s=t(58097),a="undefined"!=typeof global?global:"undefined"!=typeof self?self:{};a.__sentryRewritesTunnelPath__=void 0,a.SENTRY_RELEASE={id:"wdkRqJwFkIUdQPuSy7-Vq"},a.__sentryBasePath=void 0,a.__rewriteFramesDistDir__=".next",s.init({dsn:process.env.SENTRY_DSN,tracesSampleRate:.1,integrations:[new s.BrowserTracing({tracePropagationTargets:["localhost",/^https:\/\/[^/]*\.basednet\.com/]})],environment:"production",beforeSend(e){if(e.exception){let r=e.exception.values?.[0]?.value;if(r?.includes("ResizeObserver loop"))return null}return e},debug:!1,maxBreadcrumbs:50,attachStacktrace:!0})},56654:(e,r,t)=>{t.d(r,{Z:()=>s});let s=new(t(35900)).Pool({user:process.env.POSTGRES_USER,password:process.env.POSTGRES_PASSWORD,host:process.env.POSTGRES_HOST,port:parseInt(process.env.POSTGRES_PORT||"5432"),database:process.env.POSTGRES_DB,ssl:{rejectUnauthorized:!1}})},95439:(e,r,t)=>{t.d(r,{t:()=>a});var s=t(56654);class a{static async create(e,r){let t=["user_id",...Object.keys(r)],a=[e,...Object.values(r)],n=t.map((e,r)=>`$${r+1}`).join(", "),i=`
      INSERT INTO profiles (${t.join(", ")})
      VALUES (${n})
      RETURNING *
    `;return(await s.Z.query(i,a)).rows[0]}static async findByUserId(e){return(await s.Z.query("SELECT * FROM profiles WHERE user_id = $1",[e])).rows[0]||null}static async update(e,r){let t=["display_name","bio","avatar_url","theme_preferences","custom_css","custom_html","social_links"],a=Object.keys(r).filter(e=>t.includes(e));if(0===a.length)return null;let n=a.map((e,r)=>`${e} = $${r+2}`).join(", "),i=a.map(e=>{let t=r[e];return["theme_preferences","social_links"].includes(e)?JSON.stringify(t):t}),o=`
      UPDATE profiles 
      SET ${n}, updated_at = CURRENT_TIMESTAMP 
      WHERE user_id = $1 
      RETURNING *
    `;return(await s.Z.query(o,[e,...i])).rows[0]||null}static async delete(e){return(await s.Z.query("DELETE FROM profiles WHERE user_id = $1 RETURNING id",[e])).rowCount>0}static async getTheme(e){let r=await s.Z.query("SELECT theme_preferences FROM profiles WHERE user_id = $1",[e]);return r.rows[0]?.theme_preferences||null}static async updateTheme(e,r){let t=`
      UPDATE profiles 
      SET theme_preferences = $2, updated_at = CURRENT_TIMESTAMP 
      WHERE user_id = $1
    `;return(await s.Z.query(t,[e,JSON.stringify(r)])).rowCount>0}}},937:(e,r,t)=>{t.d(r,{T:()=>a});var s=t(56654);class a{static async create(e,r,t){let a=`
      INSERT INTO users (username, email, auth_domain)
      VALUES ($1, $2, $3)
      RETURNING *
    `;return(await s.Z.query(a,[e,r,t])).rows[0]}static async findById(e){return(await s.Z.query("SELECT * FROM users WHERE id = $1",[e])).rows[0]||null}static async findByUsername(e){return(await s.Z.query("SELECT * FROM users WHERE username = $1",[e])).rows[0]||null}static async update(e,r){let t=["username","email","auth_domain"],a=Object.keys(r).filter(e=>t.includes(e));if(0===a.length)return null;let n=a.map((e,r)=>`${e} = $${r+2}`).join(", "),i=a.map(e=>r[e]),o=`
      UPDATE users 
      SET ${n}, updated_at = CURRENT_TIMESTAMP 
      WHERE id = $1 
      RETURNING *
    `;return(await s.Z.query(o,[e,...i])).rows[0]||null}static async delete(e){return((await s.Z.query("DELETE FROM users WHERE id = $1 RETURNING id",[e])).rowCount??0)>0}static async list(e=10,r=0){return(await s.Z.query("SELECT * FROM users ORDER BY created_at DESC LIMIT $1 OFFSET $2",[e,r])).rows}}},8593:(e,r,t)=>{t.d(r,{Fs:()=>o,mk:()=>u,ts:()=>i});var s=t(8317),a=t(2094),n=t(937);async function i(){let e=await (0,s.Z1)(a.authOptions);return e?.user?.id?await n.T.findById(e.user.id):null}async function o(e,r){return e===r}async function u(){let e=await (0,s.Z1)(a.authOptions);if(!e?.user?.id)throw Error("Authentication required");return e}t(95439)}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[565,834,98],()=>t(82699));module.exports=s})();
//# sourceMappingURL=route.js.map